---
import { gql, GraphQLClient } from 'graphql-request'
import Card from './card/Card.astro'
import Skeleton from './card/Skeleton.astro'
const githubAccessToken = import.meta.env.GITHUB_ACCESS_TOKEN

interface GitHubPinnedRepo {
  id: string
  name: string
  description: string
  url: string
  homepageUrl: string
  languages: {
    nodes: {
      name: string
      color: string
    }[]
  }
  forkCount: number
  stargazerCount: number
}

interface GitHubPinnedRepos {
  viewer: {
    pinnedItems: {
      nodes: GitHubPinnedRepo[]
    }
  }
}

const GITHUB_API_URL = 'https://api.github.com/graphql'

const GITHUB_PINNED_REPOS = gql`
  query {
    viewer {
      pinnedItems(first: 6, types: REPOSITORY) {
        nodes {
          ... on Repository {
            id
            name
            description
            url
            homepageUrl
            languages(first: 3) {
              nodes {
                name
                color
              }
            }
            forkCount
            stargazerCount
          }
        }
      }
    }
  }
`

const graphQLClient = new GraphQLClient(GITHUB_API_URL, {
  headers: {
    authorization: `Bearer ${githubAccessToken}`
  }
})

let repos: GitHubPinnedRepo[] = []

try {
  if (githubAccessToken) {
    const data = await graphQLClient.request<GitHubPinnedRepos>(
      GITHUB_PINNED_REPOS,
      {}
    )
    repos = data.viewer.pinnedItems.nodes
  }
} catch (error) {
  console.error('Failed to fetch GitHub repos:', error)
  // Fallback data for development/preview without valid token
  repos = [
    {
      id: '1',
      name: 'portfolio-v2',
      description: 'Mi sitio web personal construido con Astro y Tailwind CSS.',
      url: 'https://github.com/mralexsaavedra/mralexsaavedra.dev',
      homepageUrl: 'https://mralexsaavedra.dev',
      languages: { nodes: [{ name: 'TypeScript', color: '#3178c6' }] },
      forkCount: 2,
      stargazerCount: 15
    },
    {
      id: '2',
      name: 'react-component-lib',
      description: 'Una biblioteca de componentes minimalista para React.',
      url: '#',
      homepageUrl: '',
      languages: { nodes: [{ name: 'TypeScript', color: '#3178c6' }] },
      forkCount: 5,
      stargazerCount: 42
    }
  ]
}
---

<div class='w-full flex flex-col md:grid grid-cols-2 gap-4'>
  {
    repos && repos.length > 0
      ? repos.map(
          ({
            description,
            forkCount,
            languages,
            name,
            stargazerCount,
            url
          }) => (
            <Card
              url={url}
              forkCount={forkCount}
              description={description}
              name={name}
              stargazerCount={stargazerCount}
              language={languages.nodes[0]}
            />
          )
        )
      : [...Array(6)].map(() => <Skeleton />)
  }
</div>
